{% extends "base.html" %}
{% from "_formhelpers.html" import render_field, render_radio_field, render_select_field %}

{% block title %}{{ title }}{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}"> {# Assuming you have a forms.css #}
    <style>
        .risk-calculator-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .form-section:last-child {
            border-bottom: none;
        }
        .form-section h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 2px solid var(--primary-color, #007bff);
            padding-bottom: 5px;
        }
        .results-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .results-section h3 {
            margin-top: 0;
            color: var(--primary-color, #007bff);
        }
        .score-display {
            font-size: 2em;
            font-weight: bold;
            color: #d9534f; /* Default to red, change based on score */
        }
        .score-low { color: #5cb85c; }
        .score-medium { color: #f0ad4e; }
        .score-high { color: #d9534f; }
        .score-critical { color: #800000; } /* Darker red for critical */

        /* Style for radio buttons to be more compact if needed */
        .form-group-radio div { display: flex; flex-wrap: wrap; gap: 15px; }
        .form-group-radio label { margin-right: 0; } /* WTForms might add its own label wrapper */
        .form-group-radio input[type="radio"] { margin-right: 5px; }

    </style>
{% endblock %}

{% block content %}
<div class="risk-calculator-container">
    <h1 class="mb-4">{{ title }}</h1>
    <p class="text-muted">Select the appropriate values for each metric to calculate a conceptual risk score.</p>

    <form method="POST" action="{{ url_for('utils_bp.risk_calculator') }}" novalidate>
        {{ form.hidden_tag() }} {# CSRF token #}

        <div class="form-section">
            <h3>Base Metrics</h3>
            <div class="row">
                <div class="col-md-6">
                    {{ render_radio_field(form.attack_vector, class="form-check-input") }}
                </div>
                <div class="col-md-6">
                    {{ render_radio_field(form.privileges_required, class="form-check-input") }}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    {{ render_radio_field(form.attack_complexity, class="form-check-input") }}
                </div>
                <div class="col-md-6">
                    {{ render_radio_field(form.user_interaction, class="form-check-input") }}
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Impact Metrics</h3>
             <div class="row">
                <div class="col-md-12">
                    {{ render_select_field(form.aitc, class="form-select") }}
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    {{ render_select_field(form.characteristic_impact, class="form-select") }}
                </div>
                <div class="col-md-6">
                    {{ render_select_field(form.legal_impact, class="form-select") }}
                </div>
            </div>
        </div>

        <div class="mt-4">
            {{ form.submit(class="btn btn-primary btn-lg") }}
        </div>
    </form>

    {% if results %}
    <div class="results-section mt-5">
        <h3>Calculation Results</h3>
        <hr>
        <h4>Selected Values:</h4>
        <ul>
            <li><strong>Attack Vector:</strong> {{ results.selected_data.attack_vector }}</li>
            <li><strong>Privileges Required:</strong> {{ results.selected_data.privileges_required }}</li>
            <li><strong>Attack Complexity:</strong> {{ results.selected_data.attack_complexity }}</li>
            <li><strong>User Interaction:</strong> {{ results.selected_data.user_interaction }}</li>
            <li><strong>AI Trustworthy Characteristic:</strong>
                {% set selected_aitc_label = '' %}
                {% for key, label in form.aitc.choices if key == results.selected_data.aitc %}
                    {% set selected_aitc_label = label %}
                {% endfor %}
                {{ selected_aitc_label }} ({{ results.selected_data.aitc }})
            </li>
            <li><strong>Characteristic Impact:</strong> {{ results.selected_data.characteristic_impact }}</li>
            <li><strong>Legal Impact:</strong> {{ results.selected_data.legal_impact }}</li>
        </ul>

        <h4 class="mt-4">Calculated Scores (Example):</h4>
        <p><strong>Base Exploitability Component:</strong> {{ results.base_score_component }} / 10.0</p>
        <p><strong>Impact Component:</strong> {{ results.impact_score_component }} / 10.0</p>
        
        <h4 class="mt-3">Overall Risk Score:</h4>
        {% set score_class = 'score-medium' %}
        {% if results.qualitative_assessment == 'Low' %}
            {% set score_class = 'score-low' %}
        {% elif results.qualitative_assessment == 'High' %}
            {% set score_class = 'score-high' %}
        {% elif results.qualitative_assessment == 'Critical' %}
            {% set score_class = 'score-critical' %}
        {% elif results.qualitative_assessment == 'Informational' %}
            {% set score_class = 'score-low' %} {# Or a neutral color #}
        {% endif %}
        <p class="score-display {{ score_class }}">{{ results.final_score }} / 10.0</p>
        <p><strong>Qualitative Assessment:</strong> {{ results.qualitative_assessment }}</p>
        
        <p class="mt-3 text-muted"><small><em><strong>Note:</strong> {{ results.notes }}</em></small></p>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
{# Add any specific JS for this page if needed #}
{% endblock %}