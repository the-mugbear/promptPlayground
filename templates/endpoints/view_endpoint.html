{% extends "base.html" %}

{% block title %}View Endpoint{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/endpoints/inline_edit.css') }}">
<style>
    .endpoint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    
    .endpoint-header h2 {
        margin: 0;
    }
    
    .test-form-container {
        margin: 0;
    }
    
    .test-form-container h3 {
        display: none;
    }
    
    .test-form-container form {
        margin: 0;
    }
    
    .payload-container {
        position: relative;
        width: 100%;
    }
    
    .payload-textarea {
        width: 100% !important;
        height: 300px !important;
        min-height: 300px !important;
        font-family: monospace !important;
        resize: vertical !important;
        box-sizing: border-box !important;
    }
    
    .json-validation-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .json-validation-badge.valid {
        background-color: #d4edda;
        color: #155724;
        opacity: 1;
    }
    
    .json-validation-badge.invalid {
        background-color: #f8d7da;
        color: #721c24;
        opacity: 1;
    }
    
    .validation-icon {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="endpoint-details" data-endpoint-id="{{ endpoint.id }}">
        <div class="endpoint-header">
            <h2>Endpoint Details</h2>
            <div class="test-form-container">
                <form id="testForm" action="{{ url_for('endpoints_bp.test_endpoint', endpoint_id=endpoint.id) }}" method="POST">
                    <button type="submit" class="btn btn-primary">Test Endpoint</button>
                </form>
            </div>
        </div>
        
        <div class="details-grid">
            <div class="editable-field" data-field="name">
                <label>Name:</label>
                <div class="view-mode">
                    <span>{{ endpoint.name }}</span>
                </div>
                <div class="edit-mode">
                    <input type="text" class="form-control" value="{{ endpoint.name }}">
                </div>
            </div>
            
            <div class="editable-field" data-field="hostname">
                <label>Hostname:</label>
                <div class="view-mode">
                    <span>{{ endpoint.hostname }}</span>
                </div>
                <div class="edit-mode">
                    <input type="text" class="form-control" value="{{ endpoint.hostname }}">
                </div>
            </div>
            
            <div class="editable-field" data-field="path">
                <label>Path:</label>
                <div class="view-mode">
                    <span>{{ endpoint.endpoint }}</span>
                </div>
                <div class="edit-mode">
                    <input type="text" class="form-control" value="{{ endpoint.endpoint }}">
                </div>
            </div>

            <div class="info-field">
                <label>Created:</label>
                <span>{{ endpoint.timestamp }}</span>
            </div>
        </div>

        <div class="editable-field" data-field="http_payload">
            <label>HTTP Payload:</label>
            <div class="view-mode">
                <span>{{ endpoint.http_payload }}</span>
            </div>
            <div class="edit-mode">
                <div class="payload-container">
                    <textarea class="form-control payload-textarea">{{ endpoint.http_payload }}</textarea>
                    <div class="json-validation-badge" id="jsonValidationBadge">
                        <span class="validation-icon">âœ“</span>
                        <span class="validation-text">Valid JSON</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="headers-box">
            <h3>Headers</h3>
            <div class="headers-list">
                {% if endpoint.headers and endpoint.headers|length > 0 %}
                    {% for header in endpoint.headers %}
                        <div class="header-item">
                            <span class="header-key">{{ header.key }}:</span>
                            <span class="header-value">{{ header.value }}</span>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-headers" style="display: none;"><em>No headers available.</em></p>
                {% endif %}
            </div>
        </div>

        <!-- Discovered Endpoints Section -->
        <div class="discovered-endpoints mt-4">
            <h3>Discovered Endpoints</h3>
            <div class="discovery-actions mb-3">
                <button class="btn btn-primary" onclick="startDiscovery('auto')">Discover Endpoints</button>
                <button class="btn btn-secondary" onclick="startDiscovery('openapi')">OpenAPI Discovery</button>
                <button class="btn btn-secondary" onclick="startDiscovery('google')">Google API Discovery</button>
                <button class="btn btn-secondary" onclick="startDiscovery('heuristic')">Heuristic Discovery</button>
            </div>
            
            <div id="discoveryStatus" class="alert alert-info" style="display: none;">
                Discovery in progress...
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Path</th>
                            <th>Method</th>
                            <th>Status Code</th>
                            <th>Discovered At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="discoveredEndpoints">
                        {% for discovered in endpoint.discovered_endpoints %}
                        <tr>
                            <td>{{ discovered.path }}</td>
                            <td>{{ discovered.method }}</td>
                            <td>
                                <span class="badge {% if discovered.status_code < 400 %}bg-success{% elif discovered.status_code < 500 %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ discovered.status_code }}
                                </span>
                            </td>
                            <td>{{ discovered.discovered_at }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="testDiscoveredEndpoint('{{ discovered.path }}', '{{ discovered.method }}')">Test</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        {% if test_result %}
            <div class="test-results">
                <h4>Test Results</h4>
                
                <div class="result-section">
                    <h5>Status Code</h5>
                    <div class="status-code">{{ test_result.status_code }}</div>
                </div>

                <div class="result-section">
                    <h5>Response</h5>
                    <pre class="response-data">{{ test_result.response_data }}</pre>
                </div>

                <div class="result-section">
                    <h5>Headers Sent</h5>
                    <pre class="headers-sent">{{ test_result.headers_sent | tojson(indent=2) }}</pre>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/endpoints/inline_edit.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.querySelector('.payload-textarea');
    const badge = document.getElementById('jsonValidationBadge');
    
    function validateJSON() {
        try {
            const value = textarea.value.trim();
            if (!value) {
                badge.className = 'json-validation-badge';
                return;
            }
            JSON.parse(value);
            badge.className = 'json-validation-badge valid';
            badge.querySelector('.validation-text').textContent = 'Valid JSON';
        } catch (e) {
            badge.className = 'json-validation-badge invalid';
            badge.querySelector('.validation-text').textContent = 'Invalid JSON';
        }
    }
    
    textarea.addEventListener('input', validateJSON);
    validateJSON(); // Initial validation
});

function startDiscovery(strategy) {
    const endpointId = document.querySelector('.endpoint-details').dataset.endpointId;
    const statusDiv = document.getElementById('discoveryStatus');
    const tbody = document.getElementById('discoveredEndpoints');
    
    // Show status
    statusDiv.style.display = 'block';
    statusDiv.textContent = 'Discovery in progress...';
    
    // Clear existing endpoints
    tbody.innerHTML = '';
    
    // Start discovery
    fetch(`/endpoints/${endpointId}/discover`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ strategy: strategy })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        return pollDiscoveryStatus(data.task_id);
    })
    .then(endpoints => {
        // Update table with discovered endpoints
        endpoints.forEach(endpoint => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${endpoint.path}</td>
                <td>${endpoint.method}</td>
                <td>
                    <span class="badge ${endpoint.status_code < 400 ? 'bg-success' : endpoint.status_code < 500 ? 'bg-warning' : 'bg-danger'}">
                        ${endpoint.status_code}
                    </span>
                </td>
                <td>${new Date().toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="testDiscoveredEndpoint('${endpoint.path}', '${endpoint.method}')">Test</button>
                </td>
            `;
            tbody.appendChild(row);
        });
        statusDiv.style.display = 'none';
    })
    .catch(error => {
        statusDiv.className = 'alert alert-danger';
        statusDiv.textContent = `Error: ${error.message}`;
    });
}

function pollDiscoveryStatus(taskId) {
    return new Promise((resolve, reject) => {
        const checkStatus = () => {
            fetch(`/endpoints/discovery/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.state === 'SUCCESS') {
                        resolve(data.status);
                    } else if (data.state === 'FAILURE') {
                        reject(new Error(data.status));
                    } else {
                        setTimeout(checkStatus, 1000);
                    }
                })
                .catch(reject);
        };
        checkStatus();
    });
}

function testDiscoveredEndpoint(path, method) {
    const endpointId = document.querySelector('.endpoint-details').dataset.endpointId;
    // TODO: Implement endpoint testing
    alert(`Testing ${method} ${path}`);
}
</script>
{% endblock %}
