{% extends 'base.html' %}

{# Optional: Macro for pagination links - place in base.html or _macros.html #}
{% macro render_pagination(pagination, endpoint) %}
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
      {# Previous Page Link #}
      <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
        <a class="page-link" href="{% if pagination.has_prev %}{{ url_for(endpoint, page=pagination.prev_num) }}{% else %}#                                                                                                                                       {% endif %}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {# Page Number Links #}
      {% for p in pagination.iter_pages() %}
        {% if p %}
          {% if p == pagination.page %}
          <li class="page-item active" aria-current="page">
            <span class="page-link">{{ p }}</span>
          </li>
          {% else %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for(endpoint, page=p) }}">{{ p }}</a>
          </li>
          {% endif %}
        {% else %}
          <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
        {% endif %}
      {% endfor %}
      {# Next Page Link #}
      <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
        <a class="page-link" href="{% if pagination.has_next %}{{ url_for(endpoint, page=pagination.next_num) }}{% else %}#                                                                                                                                       {% endif %}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
    </ul>
  </nav>
{% endmacro %}


{% block title %}Manage Invitations - Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Manage Invitations</h1>
    <p>
        <a href="{{ url_for('admin_bp.create_invitation') }}" class="btn btn-success btn-sm">[+] Create New Invitation</a>
    </p>

    {% if invitations %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Code</th>
                    <th>Email Restriction</th>
                    <th>Assign Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Expires</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for inv in invitations %}
                <tr class="{{ 'table-secondary' if inv.is_used else ('table-warning' if not inv.is_valid() else '') }}">
                    <td>
                        <input type="text" readonly value="{{ inv.code }}" id="invite-code-{{ inv.id }}" size="18" style="background: transparent; border: none;                                                                                                                         cursor: default;">
                        <button class="btn btn-outline-secondary btn-sm py-0" onclick="copyCode('invite-code-{{ inv.id }}')" title="Copy Code">Copy</button>
                    </td>
                    <td>{{ inv.email or 'Any' }}</td>
                    <td>{{ inv.role_to_assign }}</td>
                    <td>
                        {% if inv.is_used %}
                           <span class="badge bg-secondary">Used</span>
                        {% elif not inv.is_valid() %}
                           <span class="badge bg-warning text-dark">Expired</span>
                        {% else %}
                           <span class="badge bg-success">Valid</span>
                        {% endif %}
                    </td>
                    <td>{{ inv.created_at.strftime('%Y-%m-%d %H:%M') if inv.created_at else '-'}}</td>
                    <td>{{ inv.expires_at.strftime('%Y-%m-%d %H:%M') if inv.expires_at else 'Never' }}</td>
                    <td>{{ inv.notes or '-' }}</td>
                    <td>
                        {# Add actions like Revoke later if needed #}
                        -
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {# Render pagination using the macro #}
    {{ render_pagination(pagination, 'admin_bp.list_invitations') }}

    {% else %}
    <p>No invitations found.</p>
    {% endif %}
</div>

<script>
function copyCode(elementId) {
  const input = document.getElementById(elementId);
  input.select(); // Select the text
  input.setSelectionRange(0, 99999); // For mobile devices

  try {
    navigator.clipboard.writeText(input.value);
    // Optional: Indicate success (e.g., change button text briefly)
    // alert('Code copied!');
  } catch (err) {
    console.error('Failed to copy code: ', err);
    // Fallback or error message
  }
  // Deselect text
  window.getSelection().removeAllRanges();
}
</script>

{% endblock %}

{% block scripts %}
    {{ super() }} {# Include scripts from base if needed #}
{% endblock %}