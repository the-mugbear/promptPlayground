{% extends "base.html" %}

{% block title %}Best of N Engine{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/help.css') }}">
{% endblock %}

{% block content %}
  <h1>BoN Jailbreak Configuration</h1>
  <form id="bon-form" action="{{ url_for('bon_bp.run_jailbreak') }}" method="POST">
    <div>
      <label for="adversarial_endpoint">Adversarial Endpoint:</label>
      <select name="adversarial_endpoint" id="adversarial_endpoint">
        <option value="">--Select Endpoint--</option>
        {% for ep in endpoints %}
          <option value="{{ ep.id }}">{{ ep.name }}</option>
        {% endfor %}
      </select>
      <div id="adversarial_details"></div>
    </div>
    <br>
    <div>
      <label for="recipient_endpoint">Recipient Endpoint:</label>
      <select name="recipient_endpoint" id="recipient_endpoint">
        <option value="">--Select Endpoint--</option>
        {% for ep in endpoints %}
          <option value="{{ ep.id }}">{{ ep.name }}</option>
        {% endfor %}
      </select>
      <div id="recipient_details"></div>
    </div>
    <br>
    <div>
      <label for="initial_prompt">Initial Prompt for Adversarial Endpoint:</label>
      <br>
      <textarea name="initial_prompt" id="initial_prompt" rows="4" cols="50" placeholder="Enter your initial prompt here"></textarea>
    </div>
    <br>
    <button type="submit">Run Jailbreak</button>
  </form>
  
  <h2>Attempts Log</h2>
  <div id="attempts_log">
    <!-- Each attempted prompt and its response will be appended here -->
  </div>
  
  <script>
    // Instead of intercepting form submission via $.ajax,
    // use EventSource to listen to the stream.
    $(document).ready(function() {
      $('#bon-form').submit(function(e) {
        e.preventDefault();
        $('#attempts_log').html(''); // Clear previous logs
        var formData = $(this).serialize();
        
        // Create an EventSource pointing to the /run route with a POST (using URL parameters if needed)
        // Since EventSource doesn't support POST directly, you might use a query string or refactor accordingly.
        // For example, you could send parameters via URL:
        var url = "{{ url_for('bon_bp.run_jailbreak') }}?" + formData;
        var source = new EventSource(url);
        
        source.onmessage = function(event) {
          var data = JSON.parse(event.data);
          // Append attempt information to the log.
          if (data.final) {
            $('#attempts_log').append(
              '<div class="final-result"><h3>Final Result</h3>' +
              (data.augmented_prompt ? '<pre>' + data.augmented_prompt + '</pre>' : '<p>No success</p>') +
              (data.response ? '<pre>' + data.response + '</pre>' : '') +
              '</div>'
            );
            source.close();
          } else {
            $('#attempts_log').append(
              '<div class="attempt">' +
                '<p><strong>Attempt ' + data.attempt + ':</strong></p>' +
                '<p><em>Prompt:</em> ' + data.prompt + '</p>' +
                '<p><em>Response:</em> ' + data.response + '</p>' +
                '<hr>' +
              '</div>'
            );
          }
        };
      
        
        source.onerror = function() {
          $('#attempts_log').append('<p>Error receiving stream.</p>');
          source.close();
        };
    });
  });
  </script>
  
{% endblock %}
