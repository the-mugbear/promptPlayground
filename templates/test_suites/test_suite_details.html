{% extends "base.html" %}

{% block title %}Test Suite Details{% endblock %}

{% block head %}
  {{ super() }}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/cards.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/forms.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/buttons.css') }}">
  <style>
    /* Test suite specific styling */
    .test-suite-details .editable {
      background: transparent;
      border: 1px dashed transparent;
      padding: 0.25rem;
      border-radius: var(--border-radius-sm);
      transition: var(--transition-fast);
    }
    
    .test-suite-details .editable:hover {
      border-color: var(--accent-color);
      background: var(--surface-color-light);
    }
    
    .test-suite-details .editable:focus {
      outline: none;
      border-color: var(--accent-color);
      background: var(--surface-color);
      box-shadow: 0 0 0 2px rgba(var(--accent-color-rgb), 0.2);
    }
    
    .card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
    }
    
    .card-header {
      background: var(--surface-color-light);
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition-fast);
    }
    
    .card-header:hover {
      background: var(--surface-color-lighter);
    }
    
    .card-body {
      background: var(--surface-color);
    }
    
    .original-prompt {
      font-family: var(--font-mono);
      background: var(--code-bg);
      padding: 1rem;
      border-radius: var(--border-radius-sm);
      border-left: 3px solid var(--accent-color);
    }
    
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
  </style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="test-suite-details" data-suite-id="{{ test_suite.id }}">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>
        Test Suite: 
        <span class="editable" contenteditable="true" data-field="description">
          {{ test_suite.description }}
        </span>
      </h1>
      <div class="action-buttons">
        <a 
          href="{{ url_for('test_suites_bp.export_test_suite', suite_id=test_suite.id) }}" 
          class="btn btn-secondary"
        >
          Export Suite
        </a>
      </div>
    </div>
    <p>
      <strong>Behavior:</strong>
      <span class="editable" contenteditable="true" data-field="behavior">
        {{ test_suite.behavior or "N/A" }}
      </span>
    </p>
    <p>
      <strong>Objective:</strong>
      <span class="editable" contenteditable="true" data-field="objective">
        {{ test_suite.objective or "N/A" }}
      </span>
    </p>
    <p>
      <strong>Created By:</strong>
      {% if test_suite.user %}
        {{ test_suite.user.username }}
      {% else %}
        N/A
      {% endif %}
    </p>
    <p>
      <strong>Created At:</strong>
      {% if test_suite.created_at %}
        {{ test_suite.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
      {% else %}
        N/A
      {% endif %}
    </p>
  </div>

  <!-- Filter Input -->
  <div class="form-group mt-4">
    <input type="text" id="promptFilter" class="form-control" placeholder="Filter test cases by Original Prompt">
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5>Add New Test Case</h5>
      <form id="add-test-case-form" class="form-inline">
        <div class="form-group mr-2 flex-grow-1">
          <textarea
            id="new-prompt"
            class="form-control w-100"
            rows="2"
            placeholder="Enter the new promptâ€¦"></textarea>
        </div>
        <button type="submit" class="btn btn-success">Add</button>
      </form>
    </div>
  </div>  

  <h2 class="mt-4">Associated Test Cases</h2>
  {% if test_suite.test_cases and test_suite.test_cases|length > 0 %}
    <div id="accordion">
      {% for case in test_suite.test_cases %}
        <div class="card mb-2" id="test-case-{{ case.id }}">
          <div class="card-header" id="heading-{{ case.id }}" data-toggle="collapse" data-target="#collapse-{{ case.id }}" aria-expanded="false" aria-controls="collapse-{{ case.id }}">
            <h5 class="mb-0">
              {{ loop.index }}. {{ case.prompt | truncate(50) }}
            </h5>
          </div>
          <div id="collapse-{{ case.id }}" class="collapse" aria-labelledby="heading-{{ case.id }}" data-parent="#accordion">
            <div class="card-body">
              <!-- Wrap the original prompt with a class for filtering -->
              <p class="original-prompt"><strong>Original Prompt:</strong> {{ case.prompt }}</p>
              <p><strong>Source:</strong> {{ case.source or "N/A" }}</p>
              <p><strong>Attack Type:</strong> {{ case.attack_type or "N/A" }}</p>
              <p><strong>Data Type:</strong> {{ case.data_type or "N/A" }}</p>
              <p><strong>NIST Risk:</strong> {{ case.nist_risk or "N/A" }}</p>
              <p><strong>Reviewed:</strong> {{ case.reviewed if case.reviewed is not none else "N/A" }}</p>
              <p>
                <strong>Created At:</strong>
                {% if case.created_at %}
                  {{ case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                  N/A
                {% endif %}
              </p>
              {% if case.transformations %}
                <p><strong>Transformations:</strong></p>
                <ul>
                  {% for trans in case.transformations %}
                    <li>
                      {% if trans is mapping %}
                        {{ trans['type'] }}
                        {% if trans['value'] %}
                          - Parameter: {{ trans['value'] }}
                        {% endif %}
                      {% else %}
                        {{ trans }}
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p><strong>Transformations:</strong> None</p>
              {% endif %}
              <div class="mt-2">
                <!-- Action Buttons -->
                <button class="action-btn btn btn-warning btn-sm remove-btn" data-case-id="{{ case.id }}">Remove from Suite</button>
                <button class="action-btn btn btn-danger btn-sm delete-btn" data-case-id="{{ case.id }}">Delete Test Case</button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>No test cases are associated with this test suite.</p>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/testSuites/test_suite_details.js') }}"></script>
  <script>
    // Replace Bootstrap collapse functionality with vanilla JS
    document.addEventListener('DOMContentLoaded', function() {
      const collapseTriggers = document.querySelectorAll('[data-toggle="collapse"]');
      
      collapseTriggers.forEach(trigger => {
        trigger.addEventListener('click', function(e) {
          e.preventDefault();
          const targetSelector = this.getAttribute('data-target');
          const target = document.querySelector(targetSelector);
          
          if (target) {
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            
            // Toggle the collapse
            if (isExpanded) {
              target.style.display = 'none';
              this.setAttribute('aria-expanded', 'false');
              target.classList.remove('show');
            } else {
              target.style.display = 'block';
              this.setAttribute('aria-expanded', 'true');
              target.classList.add('show');
            }
          }
        });
      });
    });
  </script>
{% endblock %}
