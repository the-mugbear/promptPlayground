{% extends "base.html" %}

{% block title %}Test Suite Details{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}">
  <!-- Bootstrap CSS (required for structure) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Custom cyberpunk theme overrides -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-overrides.css') }}">
{% endblock %}

{% block content %}
<div class="container">
  <div class="test-suite-details" data-suite-id="{{ test_suite.id }}">
    <h1>
      Test Suite: 
      <span class="editable" contenteditable="true" data-field="description">
        {{ test_suite.description }}
      </span>
    </h1>
    <p>
      <strong>Behavior:</strong>
      <span class="editable" contenteditable="true" data-field="behavior">
        {{ test_suite.behavior or "N/A" }}
      </span>
    </p>
    <p>
      <strong>Objective:</strong>
      <span class="editable" contenteditable="true" data-field="objective">
        {{ test_suite.objective or "N/A" }}
      </span>
    </p>
    <p>
      <strong>Created At:</strong>
      {% if test_suite.created_at %}
        {{ test_suite.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
      {% else %}
        N/A
      {% endif %}
    </p>
  </div>

  <h2 class="mt-4">Associated Test Cases</h2>
  {% if test_suite.test_cases and test_suite.test_cases|length > 0 %}
    <div id="accordion">
      {% for case in test_suite.test_cases %}
        <div class="card mb-2" id="test-case-{{ case.id }}">
          <div class="card-header" id="heading-{{ case.id }}" data-toggle="collapse" data-target="#collapse-{{ case.id }}" aria-expanded="false" aria-controls="collapse-{{ case.id }}">
            <h5 class="mb-0">
              {{ loop.index }}. {{ case.prompt | truncate(50) }}
            </h5>
          </div>
          <div id="collapse-{{ case.id }}" class="collapse" aria-labelledby="heading-{{ case.id }}" data-parent="#accordion">
            <div class="card-body">
              <p><strong>Original Prompt:</strong> {{ case.prompt }}</p>
              <p><strong>Source:</strong> {{ case.source or "N/A" }}</p>
              <p><strong>Attack Type:</strong> {{ case.attack_type or "N/A" }}</p>
              <p><strong>Data Type:</strong> {{ case.data_type or "N/A" }}</p>
              <p><strong>NIST Risk:</strong> {{ case.nist_risk or "N/A" }}</p>
              <p><strong>Reviewed:</strong> {{ case.reviewed if case.reviewed is not none else "N/A" }}</p>
              <p>
                <strong>Created At:</strong>
                {% if case.created_at %}
                  {{ case.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                {% else %}
                  N/A
                {% endif %}
              </p>
              {% if case.transformations %}
                <p><strong>Transformations:</strong></p>
                <ul>
                  {% for trans in case.transformations %}
                    <li>
                      {% if trans is mapping %}
                        {{ trans['type'] }}
                        {% if trans['value'] %}
                          - Parameter: {{ trans['value'] }}
                        {% endif %}
                      {% else %}
                        {{ trans }}
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p><strong>Transformations:</strong> None</p>
              {% endif %}
              <div class="mt-2">
                <!-- Action Buttons -->
                <button class="action-btn btn btn-warning btn-sm remove-btn" data-case-id="{{ case.id }}">Remove from Suite</button>
                <button class="action-btn btn btn-danger btn-sm delete-btn" data-case-id="{{ case.id }}">Delete Test Case</button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p>No test cases are associated with this test suite.</p>
  {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Inline editing for test suite fields (same as before)
  const editableFields = document.querySelectorAll(".editable");
  editableFields.forEach(function(field) {
    field.addEventListener("blur", function(event) {
      const newValue = event.target.textContent.trim();
      const fieldName = event.target.getAttribute("data-field");
      const suiteId = event.target.closest(".test-suite-details").getAttribute("data-suite-id");

      const payload = {};
      payload[fieldName] = newValue;

      fetch("/test_suites/" + suiteId + "/update", {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "XMLHttpRequest"
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error("Failed to update " + fieldName);
        }
        return response.json();
      })
      .then(data => {
        console.log("Updated", fieldName, data);
      })
      .catch(error => {
        console.error("Error updating test suite:", error);
        alert("Error updating " + fieldName);
      });
    });
  });

  // Add cyberpunk hover effect
  const buttons = document.querySelectorAll(".btn");
  buttons.forEach(function(btn) {
    btn.classList.add("neon-hover");
  });

  // Remove test case from suite handler
  document.querySelectorAll(".remove-btn").forEach(function(btn) {
    btn.addEventListener("click", function(event) {
      event.stopPropagation(); // Prevent accordion toggle
      const caseId = btn.getAttribute("data-case-id");
      const suiteId = document.querySelector(".test-suite-details").getAttribute("data-suite-id");
      if (confirm("Are you sure you want to remove this test case from the suite?")) {
        fetch(`/test_suites/${suiteId}/remove_test_case/${caseId}`, {
          method: "POST",
          headers: {"Content-Type": "application/json"}
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("Failed to remove test case");
          }
          return response.json();
        })
        .then(data => {
          console.log(data.message);
          // Optionally remove the card element.
          document.getElementById("test-case-" + caseId).remove();
        })
        .catch(error => {
          console.error("Error removing test case:", error);
          alert("Error removing test case");
        });
      }
    });
  });

  // Delete test case entirely handler
  document.querySelectorAll(".delete-btn").forEach(function(btn) {
    btn.addEventListener("click", function(event) {
      event.stopPropagation(); // Prevent accordion toggle
      const caseId = btn.getAttribute("data-case-id");
      if (confirm("Deleting this test case will remove it from all test suites. Proceed?")) {
        fetch(`/test_cases/${caseId}`, {
          method: "DELETE",
          headers: {"Content-Type": "application/json"}
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("Failed to delete test case");
          }
          return response.json();
        })
        .then(data => {
          console.log(data.message);
          document.getElementById("test-case-" + caseId).remove();
        })
        .catch(error => {
          console.error("Error deleting test case:", error);
          alert("Error deleting test case");
        });
      }
    });
  });
});
</script>
{% endblock %}